<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml" xmlns:o="urn:schemas-microsoft-com:office:office">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>talk应用</title>
		
<script type="text/javascript" src="/lib/JS/JS.js">
</script>
<script type="text/javascript" src="/lib/JS/Observable.js">
</script>
<script type="text/javascript" src="/lib/JS/XMLHttpRequest.js">
</script>
<script type="text/javascript" src="/lib/JS/AJAX.js">
</script>
<script type="text/javascript" src="/lib/JS/Connector.js">
</script>
<script type="text/javascript" src="/lib/JS/Engine.js">
</script>
		
<style type="text/css">
.style1 {
	text-align: center;
}
.style2 {
	text-align: right;
}
</style>
<script type="text/javascript">
function init(){
	JS.Engine.on('start',function(cId, aml, engine){
		document.getElementById('state').innerHTML = '已连接，ID:'+cId;
		document.getElementById('userName').value = cId;

		engine.on({
			stop : function(url,cId, engine){
				document.getElementById('state').innerHTML = '已断开';
			},
			talker : function(data, time, engine){
				alert('talker');
				switch(data.type)
				{
					case 'rename': //改名
						onRename(data);
						break;
					case 'talk': //收到聊天消息
						onReceive(data);
						break;
					case 'up': //上线
						onRename(data);
						break;
					case 'down': //下线
						onReceive(data);
						break;
					default :
				}
			}
		});
		getOnlineList();
	})
}
//用户列表-获取
function getOnlineList(){
	JS.AJAX.getJson('/talk.do?cmd=list', '',function(data){
		initUserList(data);
	});
}
//用户列表-初始化用户列表
function initUserList(userList){
	for(var i=0,len=userList.length;i<len;i++){
		insertUser(userList[i].id);
	}
}
//用户列表-插入一个用户
function insertUser(id){
	var userListDom = document.getElementById("userList");
	for(var i=0,len=userListDom.options.length; i<len; i++){
		var opt = userListDom.options[i];
		if(opt.value==id){
			return;
		}
	}
	var opt =document.createElement("option");
	opt.text = '未命名'+(userListDom.options.length+1);
	opt.value = id 
	userListDom.add(opt);
}
//用户列表-删除一个用户
function removeUser(id){
	var userListDom = document.getElementById("userList");
	for(var i=0,len=userListDom.options.length; i<len; i++){
		var opt = userListDom.options[i];
		if(opt.value==id){
			userListDom.remove(opt);
		}
	}
}

//用户列表-取消用户的选中状态
function clearSelectedUser(){
	var userListDom = document.getElementById("userList");
	for(var i=0,len=userListDom.options.length; i<len; i++){
		var opt = userListDom.options[i];
		opt.selected = false;
	}
}
//用户列表-得到用户选中的用户ID
function getSelectedUserId(){
	var userId = '';
	var userListDom = document.getElementById("userList");
	for(var i=0,len=userListDom.options.length; i<len; i++){
		var opt = userListDom.options[i];
		if(opt.selected){
			return opt.value;
		}
	}
	return userId;
}
//用户列表-得到用户名称
function getUserName(id){
	var userListDom = document.getElementById("userList");
	for(var i=0,len=userListDom.options.length; i<len; i++){
		var opt = userListDom.options[i];
		if(opt.value==id){
			return opt.text;
		}
	}
	return '';
}

//改名事件处理函数
function onRename(data){
	var userListDom = document.getElementById("userList");
	for(var i=0,len=userListDom.options.length; i<len; i++){
		var opt = userListDom.options[i];
		if(opt.value==data.id){
			opt.text = data.name;
			return;
		}
	}
}
//聊天事件处理函数
function onReceive(data){
	var fromId = data.form;
	var toId = data.to;
	var text = data.text;
	var myName = getUserName(fromId);
	var toName = getUserName(to);
	if(!toName){
		toName = '大家';
	}
	var str = '['+myName+']对['+toName+']说：'+text;
	insertTalkBox(str);
}
//发送聊天信息动作
function send(){
	var text = document.getElementById('myWordBox').value;
	var fromId = JS.Engine.getId();
	var toId = getSelectedUserId();
	var param = "&from="+fromId+'&to='+toId+'&text='+encodeURIComponent(text);
	JS.AJAX.post('/talk.do?cmd=send', param,function(){
		var toName = getUserName(toId);
		if(!toName){
			toName = '大家';
		}
		var str = '[我]对['+toName+']说：'+text;
		insertTalkBox(str);
		document.getElementById('myWordBox').value = '';
	});
}
//停止动作
function stop(){
	JS.Engine.stop();
}
//连接动作
function conn(){
	JS.Engine.start('/conn');
}
//改名动作
function rename(){
	var userName = document.getElementById('userName').value;
	var fromId = JS.Engine.getId();
	var param = "&id="+fromId+'&name='+userName ;
	JS.AJAX.post('/talk.do?cmd=send', param);
	
}
//聊天记录-清屏
function clsTalkBox(){
	document.getElementById('talkBox').value='';
}
//聊天记录-插入
function insertTalkBox(str){
	str+='\n'
	document.getElementById('talkBox').value += str;
}
</script>
    </head>
    <body onload="init()">
    
    <table style="width: 100%; ">
		<tr>
			<td colspan="2" class="style1">简易聊天室 Power by Comet4J Demo </td>
		</tr>
		<tr>
			<td style="width: 126px" class="style2">连接状态：</td>
			<td><div id="state">未连接</div></td>
		</tr>
		<tr>
			<td style="width: 126px" rowspan="2">
			<select id="userList" style="width:100%; height: 550px;" multiple="multiple" name="D1">
			</select></td>
			<td>
			<textarea id="talkBox" style="width: 100%; height: 400px" readonly="readonly"></textarea></td>
		</tr>
		<tr>
			<td>
			
				<textarea id="myWordBox" style="width:100%; height: 100px"></textarea>
			<br />
				<input onclick="send();" type="button" value="发送" /><input onclick="stop()" type="button" value="断开" /><input onclick="conn()" type="button" value="连接" /><input onclick="clsTalkBox()" type="button" value="清屏" /> 
				<input style="width:300px;" id="userName" type="text" /><input  onclick="rename()" type="button" value="改名" /></td>
		</tr>
		</table>
    
    </body>
</html>
