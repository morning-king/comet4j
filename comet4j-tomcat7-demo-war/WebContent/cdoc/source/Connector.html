<html>
<head>
  <title>The source code</title>
    <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
    <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
</head>
<body  onload="prettyPrint();">
    <pre class="prettyprint lang-js">/*
 * Comet4J JavaScript Client V0.0.2
 * Copyright(c) 2011, jinghai.xiao@gamil.com.
 * http://code.google.com/p/comet4j/
 * This code is licensed under BSD license. Use it as you wish, 
 * but keep this copyright intact.
 */

<div id="cls-JS.Connector"></div>/**
 * @class JS.Connector
 * @extends JS.Observable
 * 连接器,负责建立并维持连接，接收服务器端推送的数据。
 * @author jinghai.xiao@gmail.com
 */
JS.ns("JS.Connector");
JS.Connector = JS.extend(JS.Observable,{
   <div id="prop-JS.Connector-version"></div>/** 
    * 版本
    * @property 
    * @type String
    */ 
	version : '0.0.2',
	SYSCHANNEL:'c4j', //协议常量
	<div id="prop-JS.Connector-LLOOPSTYLE"></div>/** 
	 * 长轮询工作模式常量
	 * @property 
	 * @type String
	 */ 
	LLOOPSTYLE : 'lpool',//协议常量
	<div id="prop-JS.Connector-STREAMSTYLE"></div>/** 
	 * 长连接工作模式常量
	 * @property 
	 * @type String
	 */ 
	STREAMSTYLE : 'stream',//协议常量
	CMDTAG : 'cmd',
	<div id="cfg-JS.Connector-url"></div>/**
	 * @cfg {String} url 
	 * 连接地址，若使用start方法中带有url，则此配置项将被覆盖。
	 */
	url : '',
	<div id="cfg-JS.Connector-param"></div>/**
	 * @cfg {Object} param 
	 * 连接参数，若使用start方法中带有param，则此配置项将被覆盖。
	 */
	param : '',
	<div id="cfg-JS.Connector-revivalDelay"></div>/**
	 * @cfg {Object} revivalDelay
	 * 复活请求延时毫秒数,默认为100
	 */
	revivalDelay : 100,
    <div id="prop-JS.Connector-cId"></div>/** 
	 * 连接ID，连接后有效
	 * @property 
	 * @type String
	 */ 
	cId : '',
	<div id="prop-JS.Connector-channels"></div>/** 
	 * 通道列表，连接后有效
	 * @property 
	 * @type Array
	 */ 
	channels : [],
	<div id="prop-JS.Connector-workStyle"></div>/** 
	 * 连接工作模式，连接后有效。值为：LLOOPSTYLE或STREAMSTYLE
	 * @property 
	 * @type String
	 */ 
	workStyle : '',
	emptyUrlError : 'URL为空',
	runningError : '连接正在运行',
	dataFormatError : '数据格式有误',
	<div id="prop-JS.Connector-running"></div>/** 
	 * 连接器是否处于运行状态
	 * @property 
	 * @type String
	 */ 
	running : false,
	_xhr : null,
	lastReceiveMessage : '',
	constructor:function(){
		JS.Connector.superclass.constructor.apply(this,arguments);
		this.addEvents([
			<div id="event-JS.Connector-beforeConnect"></div>/**
			 * @event beforeConnect 即将连接
			 * @param {String} url 连接地址
			 * @param {Connector} conn 连接器
			 */
			'beforeConnect',
			<div id="event-JS.Connector-connect"></div>/**
			 * @event connect 已连接
			 * @param {String} cId 连接ID
			 * @param {Array} channels 通道列表
			 * @param {String} workStyle 工作模式
			 * @param {Number} timeout 连接超时时间
			 * @param {Connector} conn 连接器
			 */
			'connect',
			<div id="event-JS.Connector-beforeStop"></div>/**
			 * @event beforeStop 即将停止
			 * @param {String} cause 停止原因
			 * @param {String} cId 连接ID
			 * @param {String} url 连接地址
			 * @param {Connector} conn 连接器
			 */
			'beforeStop',
			<div id="event-JS.Connector-stop"></div>/**
			 * @event stop 已停止
			 * @param {String} cause 停止原因
			 * @param {String} cId 连接ID
			 * @param {String} url 连接地址
			 * @param {Connector} conn 连接器
			 */
			'stop',
			<div id="event-JS.Connector-message"></div>/**
			 * @event message 接收到推送数据
			 * @param {String} channel 通道标识
			 * @param {Object} data 数据对象
			 * @param {Number} time 发送时间，距1970-01-01 00:00:00毫秒数
			 * @param {Connector} conn 连接器
			 */
			'message',
			<div id="event-JS.Connector-revival"></div>/**
			 * @event revival 请求复活，用于保持连接。
			 * @param {String} url 连接地址
			 * @param {String} cId 连接ID
			 * @param {Connector} conn 连接器
			 */
			'revival'
		]);
		if(JS.isIE7){
			this._xhr = new JS.XMLHttpRequest({
				specialXHR : 'Msxml2.XMLHTTP.6.0'
			});
		}else{
			this._xhr = new JS.XMLHttpRequest();
		}
		this._xhr.addListener('readyStateChange',this.onReadyStateChange,this);
		this._xhr.addListener('timeout',this.revivalConnect,this);
		this.addListener('beforeStop',this.doDrop,this);
		JS.on(window,'beforeunload',this.doDrop,this);

	},
	//private
	doDrop : function(url,cId,conn,xhr){
		if(!this.running || !this.cId){
			return;
		}
		try {
			var xhr = new JS.XMLHttpRequest();
			var url = this.url + '?'+this.CMDTAG+'=drop&cid=' + this.cId;
			xhr.open('GET', url, false);
			xhr.send(null);
			xhr = null;
		}catch(e){};
	},
	//private distributed 派发服务器消息
	dispatchServerEvent : function(msg){
		this.fireEvent('message', msg.channel, msg.data, msg.time, this);
	},
	//private 长连接信息转换
	translateStreamData : function(responseText){
		var str = responseText;
		if(this.lastReceiveMessage && str){//剥离出接收到的数据
			str = str.split(this.lastReceiveMessage);
			str = str.length ? str[str.length-1] : "";
		}
		this.lastReceiveMessage = responseText;
		return str;
	},
	//private 消息解码
	decodeMessage : function(msg){
		var json = null;
		if(JS.isString(msg) && msg!=""){
			//解析数据格式
			if(msg.charAt(0)=="<" && msg.charAt(msg.length-1)==">"){
				msg = msg.substring(1,msg.length-1);
			}
			//JSON转换
			try{
				json = eval("("+msg+")");
			}catch(e){
				this.stop('JSON转换异常');
				//console.log(msg);
			}			
		}
		return json;
	},
	//private lisenner
	onReadyStateChange : function(readyState, status, xhr){
		if(!this.running){
			return;
		}
		if(readyState < 3){	//初始阶段
			
		}else if(readyState == 3 && (status >= 200 && status < 300)){//长轮询正常接收
			if(this.workStyle === this.STREAMSTYLE){
				var str = this.translateStreamData(xhr.responseText);
				var json = this.decodeMessage(str);
				if(json){
					this.dispatchServerEvent(json);
				}
				return;
			}
		}else if(readyState == 4 ){ //连接停止
			if(status == 0){//未知异常，一般为服务器异常停止服务或调用了abort
				if(!JS.isFirefox){ //TODO:超时状态下FireFox返回0 ,这与其自动重试10次有关,还没有找到有效办法能够确识别408
					this.stop('暂停服务');
				}
			}else if(status >= 200 && status < 300){ //长连接正常接收
				if(this.workStyle === this.LLOOPSTYLE){
					var json = this.decodeMessage(xhr.responseText);
					if(json){
						this.dispatchServerEvent(json);
					}
				}
				this.revivalConnect(); //长连接和长轮询都要重连
			}else if(status == 408){ //超时
				//this.revivalConnect();
			}else if(status > 400){
				this.stop('服务器异常');
			}
			
		}

	},
	//private
	startConnect : function(){
		if(this.running){
			var url = this.url+'?'+this.CMDTAG+'=conn&cv='+this.version+this.param;
			JS.AJAX.get(url,'',function(xhr){
				var msg = this.decodeMessage(xhr.responseText);
				if(!msg){
					this.stop('连接错误');
					return;
				}
				var data = msg.data;
				this.cId = data.cId;
				this.channels = data.channels;
				this.workStyle = data.ws;
				this._xhr.timeout = data.timeout + this.revivalDelay;
				this.fireEvent('connect', data.cId, data.channels, data.ws, data.timeout, this);
				this.revivalConnect();
			},this);
		}
	},

	//private
	revivalConnect : function(){
		var self = this;
		if(this.running){
			setTimeout(revival,this.revivalDelay);
		}
		function revival(){
			var xhr = self._xhr;
			var url = self.url + '?'+self.CMDTAG+'=revival&cid=' + self.cId + self.param;
			xhr.open('GET', url, true);
			xhr.send(null);
			self.fireEvent('revival',self.url, self.cId, self);
		}
		
	},
	<div id="method-JS.Connector-start"></div>/**
	 * 开始连接
	 * @method 
	 * @param {String} url 连接地址
	 * @param {String|DOM} param 连接参数
	 */
	start : function(url,param){
		var self = this;
		setTimeout(function(){
			if(!self.url && !url){
				throw new Error(self.emptyUrlError);
			}
			
			if(self.running){
				return;
			}
			if(url){
				self.url = url;
			}
			
			if(param && JS.isString(param)){
				if(param.charAt(0) != '&'){
					param = '&'+param;
				}
				self.param = param;
			}
			if(self.fireEvent('beforeConnect', self.url, self) === false){
				return;
			}

			self.running = true;
			self.startConnect();
		},1000);
	},
	<div id="method-JS.Connector-stop"></div>/**
	 * 停止连接
	 * @method 
	 * @param {String} cause 停止原因
	 */
	stop : function(cause){
		if(!this.running){
			return;
		}
		if(this.fireEvent('beforeStop',cause,this.cId, this.url,  this) === false){
			return;
		}
		this.running = false;
		var cId = this.cId;
		this.cId = '';
		this.param = '';
		this.adml = [];
		this.workStyle = '';
		try{
			this._xhr.abort();
		}catch(e){};
		this.fireEvent('stop',cause, cId, this.url, this);
	},
	<div id="method-JS.Connector-getId"></div>/**
	 * 获得连接ID
	 * @method 
	 * @return {String} 连接ID
	 */
	getId : function(){
		return this.cId;
	}
});
</pre>    
</body>
</html>