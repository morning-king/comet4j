/*
 * Comet4J-JS
 * Copyright(c) 2011, jinghai.xiao@gamil.com.
 * 
 * This code is licensed under BSD license. Use it as you wish, 
 * but keep this copyright intact.
 */


JS.ns("JS.HTTPStatus","JS.XMLHttpRequest");JS.HTTPStatus={'100':'Continue','101':'Switching Protocols','200':'OK','201':'Created','202':'Accepted','203':'Non-Authoritative Information','204':'No Content','205':'Reset Content','206':'Partial Content','300':'Multiple Choices','301':'Moved Permanently','302':'Found','303':'See Other','304':'Not Modified','305':'Use Proxy','306':'Unused','307':'Temporary Redirect','400':'Bad Request','401':'Unauthorized','402':'Payment Required','403':'Forbidden','404':'Not Found','405':'Method Not Allowed','406':'Not Acceptable','407':'Proxy Authentication Required','408':'Request Timeout','409':'Conflict','410':'Gone','411':'Length Required','412':'Precondition Failed','413':'Request Entity Too Large','414':'Request-URI Too Long','415':'Unsupported Media Type','416':'Requested Range Not Satisfiable','417':'Expectation Failed','500':'Internal Server Error','501':'Not Implemented','502':'Bad Gateway','503':'Service Unavailable','504':'Gateway Timeout','505':'HTTP Version Not Supported'};JS.HTTPStatus.OK=200;JS.HTTPStatus.BADREQUEST=400;JS.HTTPStatus.FORBIDDEN=403;JS.HTTPStatus.NOTFOUND=404;JS.HTTPStatus.TIMEOUT=408;JS.HTTPStatus.SERVERERROR=500;JS.XMLHttpRequest=JS.extend(JS.Observable,{enableCache:false,timeout:0,isAbort:false,specialXHR:'',_xhr:null,readyState:0,status:0,statusText:'',responseText:'',responseXML:null,constructor:function(){var self=this;this.addEvents(['readyStateChange','timeout','abort','error','load','progress']);JS.XMLHttpRequest.superclass.constructor.apply(this,arguments);this._xhr=this.createXmlHttpRequestObject();this._xhr.onreadystatechange=function(){self.doReadyStateChange();};},timeoutTask:null,delayTimeout:function(){if(this.timeout){if(!this.timeoutTask){this.timeoutTask=new JS.DelayedTask(function(){if(this._xhr.readyState!=4){this.fireEvent('timeout',this,this._xhr);}else{this.cancelTimeout();}},this);}
this.timeoutTask.delay(this.timeout);}},cancelTimeout:function(){if(this.timeoutTask){this.timeoutTask.cancel();}},createXmlHttpRequestObject:function(){var activeX=['Msxml2.XMLHTTP.6.0','Msxml2.XMLHTTP.5.0','Msxml2.XMLHTTP.4.0','Msxml2.XMLHTTP.3.0','Msxml2.XMLHTTP','Microsoft.XMLHTTP'],xhr,specialXHR=this.specialXHR;if(specialXHR){if(JS.isString(specialXHR)){return new ActiveXObject(specialXHR);}else{return specialXHR;}}
try{xhr=new XMLHttpRequest();}catch(e){for(var i=0;i<activeX.length;++i){try{xhr=new ActiveXObject(activeX[i]);break;}catch(e){}}}finally{return xhr;}},doReadyStateChange:function(){this.delayTimeout();var xhr=this._xhr;try{this.readyState=xhr.readyState;}catch(e){this.readyState=0;}
try{this.status=xhr.status;}catch(e){this.status=0;}
try{this.statusText=xhr.statusText;}catch(e){this.statusText="";}
try{this.responseText=xhr.responseText;}catch(e){this.responseText="";}
try{this.responseXML=xhr.responseXML;}catch(e){this.responseXML=null;}
this.fireEvent('readyStateChange',this.readyState,this.status,this,xhr);if(this.readyState==3&&(this.status>=200&&this.status<300)){this.fireEvent('progress',this,xhr);}
if(this.readyState==4){this.cancelTimeout();var status=this.status;if(status==0&&!this.isAbort){this.fireEvent('error',this,xhr);}else if(status>=200&&status<300){this.fireEvent('load',this,xhr);}else if(status>=400&&status!=408){this.fireEvent('error',this,xhr);}else if(status==408){this.fireEvent('timeout',this,xhr);}}
this.onreadystatechange();},onreadystatechange:function(){},open:function(method,url,async,username,password){if(!url){return;}
if(!this.enableCache){if(url.indexOf('?')!=-1){url+='&ram='+Math.random();}else{url+='?ram='+Math.random();}}
this._xhr.open(method,url,async,username,password);},send:function(content){this.delayTimeout();this.isAbort=false;this._xhr.send(content);},abort:function(){this.isAbort=true;this.cancelTimeout();this._xhr.abort();if(JS.isIE){var self=this;self._xhr.onreadystatechange=function(){self.doReadyStateChange();};}
this.fireEvent('abort',this,this._xhr);},setRequestHeader:function(header,value){this._xhr.setRequestHeader(header,value);},getResponseHeader:function(header){return this._xhr.getResponseHeader(header);},getAllResponseHeaders:function(){return this._xhr.getAllResponseHeaders();}});